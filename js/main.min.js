var SIZE=30;var CLEAR=0;var GO_LEFT=1;var GO_UP=2;var GO_RIGHT=3;var GO_DOWN=4;var DO_NOTHING=5;function Environment(b,a,c){this.context;this.widthScreen;this.heightScreen;this.matrix;this.lines;this.columns;this.showGrid=true;this.isPlay=false;this.sands;this.wallImage;this.aspirator;this.sandPercent=0.1;this.constructor=function(e,d,f){this.context=e;this.widthScreen=f;this.heightScreen=d;this.lines=0;this.columns=0;this.init();this.matrix=this.getMatrix(this.lines,this.columns);this.generateWall();this.generateRandSand();var g=this;this.sands=new Image();this.sands.src="images/sand.png";this.wallImage=new Image();this.wallImage.src="images/wall_30.png";this.sands.onload=function(){g.drawSands()};this.wallImage.onload=function(){g.drawWalls()};this.aspirator=new Aspirator(e,this,1,1);this.aspirator.draw(e)};this.init=function(){var d=0;var e=0;while(d<this.heightScreen){if(d+SIZE>this.heightScreen){break}this.lines++;d+=SIZE}while(e<this.widthScreen){if(e+SIZE>this.widthScreen){break}this.columns++;e+=SIZE}this.context.canvas.width=(SIZE)*this.columns;this.context.canvas.height=(SIZE)*this.lines};this.setSpeed=function(d){this.aspirator.speed=10-d};this.addWall=function(g,e){var d=Math.floor(g/SIZE);var f=Math.floor(e/SIZE);if(d>this.widthScreen||f>this.heightScreen){return}if(f==this.aspirator.i&&d==this.aspirator.j){return}if(f+1==this.aspirator.i&&d==this.aspirator.j){return}if(f-1==this.aspirator.i&&d==this.aspirator.j){return}if(f==this.aspirator.i&&d+1==this.aspirator.j){return}if(f==this.aspirator.i&&d-1==this.aspirator.j){return}this.matrix[f][d]=2;this.drawWall(f,d)};this.toggleWall=function(g,e){var d=Math.floor(g/SIZE);var f=Math.floor(e/SIZE);if(d>this.widthScreen||f>this.heightScreen){return}if(f==this.aspirator.i&&d==this.aspirator.j){return}if(f+1==this.aspirator.i&&d==this.aspirator.j){return}if(f-1==this.aspirator.i&&d==this.aspirator.j){return}if(f==this.aspirator.i&&d+1==this.aspirator.j){return}if(f==this.aspirator.i&&d-1==this.aspirator.j){return}if(this.matrix[f][d]==0){this.matrix[f][d]=2}else{if(this.matrix[f][d]==2){this.matrix[f][d]=0}else{this.matrix[f][d]=2}}this.drawWall(f,d)};this.getMatrix=function(e,h){var f=new Array(e);for(var g=0;g<e;g++){f[g]=new Array(h)}for(var j=0;j<e;j++){for(var d=0;d<h;d++){f[j][d]=0}}return f};this.generateWall=function(){for(var e=0;e<this.lines;e++){for(var d=0;d<this.columns;d++){if(e==0||d==0||d==this.columns-1||e==this.lines-1){this.matrix[e][d]=2}}}};this.generateRandSand=function(){var g=(this.lines*this.columns)*this.sandPercent;for(var f=0;f<g;f++){var e=Math.floor((Math.random()*(this.lines-1))+0);var d=Math.floor((Math.random()*(this.columns-1))+0);while(this.matrix[e][d]==1||this.matrix[e][d]==2){e=Math.floor((Math.random()*(this.lines-1))+0);d=Math.floor((Math.random()*(this.columns-1))+0)}this.matrix[e][d]=1}};this.drawSands=function(){for(var e=0;e<this.lines;e++){for(var d=0;d<this.columns;d++){if(this.matrix[e][d]==1){this.context.drawImage(this.sands,4+(30*d),8+(30*e))}}}};this.drawWall=function(e,d){if(this.matrix[e][d]==2){this.context.drawImage(this.wallImage,(30*d),(30*e))}};this.drawWalls=function(){for(var e=0;e<this.lines;e++){for(var d=0;d<this.columns;d++){if(this.matrix[e][d]==2){this.context.drawImage(this.wallImage,(30*d),(30*e))}}}};this.drawCell=function(f,e){if(f<0||f>=this.lines||e<0||e>=this.columns){return}this.context.beginPath();if(this.matrix[f][e]==1){var d=Math.floor(125-(16-SIZE)*12.5);this.context.fillStyle="rgb("+d+","+d+","+d+")";this.context.fillRect(e*SIZE+2,f*SIZE+2,SIZE-3,SIZE-3);this.context.fill()}else{this.context.clearRect(e*SIZE+2,f*SIZE+2,SIZE-3,SIZE-3);this.context.stroke()}};this.drawGrid=function(){if(this.showGrid){this.context.strokeStyle="rgb(71,71,71)";for(var e=1;e<this.lines;e++){this.context.beginPath();this.context.moveTo(0,0.5+e*SIZE);this.context.lineTo(this.columns*SIZE,e*SIZE);this.context.stroke()}for(var d=1;d<this.columns;d++){this.context.beginPath();this.context.moveTo(0.5+d*SIZE,0);this.context.lineTo(d*SIZE,this.lines*SIZE);this.context.stroke()}}};this.isDone=function(){if(this.isPlay){this.step()}};this.step=function(){var d=this.aspirator.applyRule();if(d==GO_LEFT){this.aspirator.moveToLeft()}if(d==GO_UP){this.aspirator.moveToUp()}if(d==GO_RIGHT){this.aspirator.moveToRight()}if(d==GO_DOWN){this.aspirator.moveToDown()}if(d==CLEAR||d==DO_NOTHING){this.step()}};this.constructor(b,a,c)}var CLEAR=0;var GO_LEFT=1;var GO_UP=2;var GO_RIGHT=3;var GO_DOWN=4;var DO_NOTHING=5;function Aspirator(c,d,b,a){this.i;this.j;this.posX;this.poxY;this.image;this.context;this.speed=5;this.env;this.construct=function(g,h,f,e){this.i=f;this.j=e;this.posX=30*e;this.posY=30*f;this.env=h;this.context=g;this.image=new Image();this.image.src="images/aspirator_28.png";var k=this;this.image.onload=function(){k.draw()};$(this).bind("isDone",function(){k.env.isDone()})};this.draw=function(e){this.context.drawImage(this.image,this.posX+1,this.posY+1)};this.moveToRight=function(){if(this.posX==(this.j+1)*SIZE){this.j++;$(this).trigger("isDone")}else{this.posX+=1;var f=(this.posX+(SIZE/2))-this.j*SIZE;this.context.clearRect(this.j*SIZE+1,this.i*SIZE+1,f,SIZE-2);this.context.beginPath();this.context.strokeStyle="rgb(71,71,71)";this.context.moveTo(0.5+30+(this.j*30),this.i*30);this.context.lineTo(0.5+30+(this.j*30),this.i*30+30);this.context.stroke();this.draw();var e=this;setTimeout(function(){e.moveToRight()},this.speed)}};this.moveToLeft=function(){if(this.posX==(this.j-1)*SIZE){this.j--;$(this).trigger("isDone")}else{this.posX-=1;var f=(this.posX+(SIZE/2))-(this.j+1)*SIZE;this.context.clearRect(this.j*SIZE+30,this.i*SIZE+1,f,SIZE-2);this.context.beginPath();this.context.strokeStyle="rgb(71,71,71)";this.context.moveTo(0.5+30+((this.j-1)*30),this.i*30);this.context.lineTo(0.5+30+((this.j-1)*30),this.i*30+30);this.context.stroke();this.draw();var e=this;setTimeout(function(){e.moveToLeft()},this.speed)}};this.moveToDown=function(){if(this.posY==(this.i+1)*SIZE){this.i++;$(this).trigger("isDone")}else{this.posY+=1;var f=(this.posY+(SIZE/2))-this.i*SIZE;this.context.clearRect(this.j*SIZE+1,this.i*SIZE+1,SIZE-2,f);this.context.beginPath();this.context.strokeStyle="rgb(71,71,71)";this.context.moveTo(this.j*30,0.5+30+(this.i*30));this.context.lineTo(this.j*30+30,0.5+30+(this.i*30));this.context.stroke();this.draw();var e=this;setTimeout(function(){e.moveToDown()},this.speed)}};this.moveToUp=function(){if(this.posY==(this.i-1)*SIZE){this.i--;$(this).trigger("isDone")}else{this.posY-=1;var f=(this.posY+(SIZE/2))-(this.i+1)*SIZE;this.context.clearRect(this.j*SIZE+1,this.i*SIZE+30,SIZE-2,f);this.context.beginPath();this.context.strokeStyle="rgb(71,71,71)";this.context.moveTo(this.j*30,0.5+30+((this.i-1)*30));this.context.lineTo(this.j*30+30,0.5+30+((this.i-1)*30));this.context.stroke();this.draw();var e=this;setTimeout(function(){e.moveToUp()},this.speed)}};this.applyRule=function(){var e=new Array;if(this.isDirty()){this.env.matrix[this.i][this.j]=0;return CLEAR}else{if(this.hasObstacleUp()&&this.hasObstacleLeft()&&this.hasObstacleRight()&&this.hasObstacleDown()){return DO_NOTHING}else{if(this.hasObstacleUp()&&this.hasObstacleLeft()&&this.hasObstacleRight()){return GO_DOWN}else{if(this.hasObstacleUp()&&this.hasObstacleDown()&&this.hasObstacleRight()){return GO_LEFT}else{if(this.hasObstacleRight()&&this.hasObstacleDown()&&this.hasObstacleLeft()){return GO_UP}else{if(this.hasObstacleUp()&&this.hasObstacleLeft()&&this.hasObstacleDown()){return GO_RIGHT}else{if(this.hasObstacleUp()&&this.hasObstacleLeft()){e.push(GO_RIGHT);e.push(GO_DOWN);return this.randomChoose(e)}else{if(this.hasObstacleUp()&&this.hasObstacleRight()){e.push(GO_LEFT);e.push(GO_DOWN);return this.randomChoose(e)}else{if(this.hasObstacleDown()&&this.hasObstacleRight()){e.push(GO_LEFT);e.push(GO_UP);return this.randomChoose(e)}else{if(this.hasObstacleUp()&&this.hasObstacleDown()){e.push(GO_LEFT);e.push(GO_RIGHT);return this.randomChoose(e)}else{if(this.hasObstacleLeft()&&this.hasObstacleRight()){e.push(GO_UP);e.push(GO_DOWN);return this.randomChoose(e)}else{if(this.hasObstacleDown()&&this.hasObstacleLeft()){e.push(GO_RIGHT);e.push(GO_UP);return this.randomChoose(e)}else{if(this.hasObstacleUp()){e.push(GO_RIGHT);e.push(GO_LEFT);e.push(GO_DOWN);return this.randomChoose(e)}else{if(this.hasObstacleDown()){e.push(GO_RIGHT);e.push(GO_LEFT);e.push(GO_UP);return this.randomChoose(e)}else{if(this.hasObstacleRight()){e.push(GO_UP);e.push(GO_LEFT);e.push(GO_DOWN);return this.randomChoose(e)}else{if(this.hasObstacleLeft()){e.push(GO_UP);e.push(GO_RIGHT);e.push(GO_DOWN);return this.randomChoose(e)}else{e.push(GO_LEFT);e.push(GO_UP);e.push(GO_RIGHT);e.push(GO_DOWN);return this.randomChoose(e)}}}}}}}}}}}}}}}}};this.isDirty=function(){if(this.env.matrix[this.i][this.j]==1){return true}return false};this.hasObstacleUp=function(){if(this.env.matrix[this.i-1][this.j]==2){return true}return false};this.hasObstacleDown=function(){if(this.env.matrix[this.i+1][this.j]==2){return true}return false};this.hasObstacleLeft=function(){if(this.env.matrix[this.i][this.j-1]==2){return true}return false};this.hasObstacleRight=function(){if(this.env.matrix[this.i][this.j+1]==2){return true}return false};this.randomChoose=function(f){var e=Math.floor((Math.random()*(f.length))+0);return f[e]};this.construct(c,d,b,a)}var mouseX=0;var mouseY=0;var context=0;var canvas=0;var env=0;var speed=7;var isPlay=false;var isPress=false;var showGrid=true;function resizeCanvas(){if($(window).width()<600){context.canvas.width=$("#menu").width()-10}else{context.canvas.width=$("#menu").width()-10}if($(window).height()<400){context.canvas.height=400}else{context.canvas.height=$(window).height()-135}}function openLink(c){var b="^#[0-9][0-9]*(,[0-9][0-9]*)*$";if(c.match(b)){var a=c.replace("#","").split(",");if(a.length%2==0){env.addValue(a)}else{console.log("fail!")}}}$(function(){canvas=document.getElementById("canvasGame");context=canvas.getContext("2d");resizeCanvas();env=new Environment(context,context.canvas.height,context.canvas.width);env.drawGrid();$("#sliderSpeed").slider({range:"min",value:5,min:1,max:10,step:1,slide:function(a,b){env.setSpeed(b.value);$("#labelSpeed").text("Speed: "+b.value)}});$("#sliderZoom").slider({range:"min",value:1,min:1,max:10,step:1,slide:function(a,b){env.zoom(b.value);$("#labelZoom").text("Zoom: "+b.value)}});$(document).bind("contextmenu",function(a){return false});$("#labelButtonGrid").addClass("ui-state-active");$("#dialog:ui-dialog").dialog("destroy");$("#dialog-modal").dialog({autoOpen:false,height:350,show:"drop",hide:"drop",width:550,modal:true,buttons:{Close:function(){$(this).dialog("close")}}});$("#anchorOpenHelp").click(function(){$("#dialog-modal").dialog("open")});$("#dialog-share").dialog({autoOpen:false,height:180,show:"drop",hide:"drop",width:550,modal:true,buttons:{Close:function(){$(this).dialog("close")}}});$("#input-link-share").focus(function(){this.select()});$("#buttonShare").click(function(){$("#input-link-share").val(location.hostname+"/gameoflife/"+game.getLink());$("#input-link-share").focus();$("#dialog-share").dialog("open")});$("#buttonGrid").button({icons:{primary:"ui-icon-calculator"}});$("#buttonZoom").button({icons:{primary:"ui-icon-zoomin"}});$("#buttonPlay").button({icons:{primary:"ui-icon-play"}});$("#buttonStop").button({icons:{primary:"ui-icon-stop"}});$("#buttonStep").button({icons:{primary:"ui-icon-seek-end"}});$("#buttonClear").button({icons:{primary:"ui-icon-trash"}});$("#buttonShare").button({icons:{primary:"ui-icon-link"}});$(window).resize(function(a){});$("#canvasGame").mousemove(function(a){if(a.offsetX){mouseX=a.offsetX;mouseY=a.offsetY}else{if(a.layerX){mouseX=a.layerX;mouseY=a.layerY}else{if(a.clientX){mouseX=a.clientX-$("#canvasGame").offset().left;mouseY=a.clientY-$("#canvasGame").offset().top}}}if(isPress){env.addWall(mouseX,mouseY)}});$("#canvasGame").click(function(a){});$("#buttonClear").click(function(a){if(!isPlay){env.clear()}});$("#buttonGrid").click(function(a){showGrid=!showGrid;env.showGrid=showGrid;if(showGrid){$("#labelButtonGrid").addClass("ui-state-active");env.drawGrid()}else{env.removeGrid();$("#labelButtonGrid").removeClass("ui-state-active")}});$("#buttonStep").click(function(a){env.step()});$("#buttonZoom").click(function(a){a.preventDefault();var b=$(this).position();$("#divContainerZoom").css("left",(b.left)+"px");console.log(b.left);$("#divContainerZoom").toggle()});$("#buttonPlay").click(function(){env.isPlay=!env.isPlay;if(env.isPlay){$("#buttonStep").fadeTo("fast",0.4);$("#buttonClear").fadeTo("fast",0.4);options={label:"Pause",icons:{primary:"ui-icon-pause"}};$(this).button("option",options);env.step()}else{$("#buttonStep").fadeTo("fast",1.9);$("#buttonClear").fadeTo("fast",1.9);options={label:"Play",icons:{primary:"ui-icon-play"}};$(this).button("option",options)}});$(document).mouseup(function(b){isPress=false;var a=$(b.target).parent();$("#divContainerZoom").hide();if(b.target.id=="divContainerZoom"||a[0].id=="divContainerZoom"||a[0].id=="sliderZoom"){$("#divContainerZoom").show()}if(a[0].id=="buttonZoom"){}});$("#canvasGame").mousedown(function(){isPress=true;env.toggleWall(mouseX,mouseY)})});